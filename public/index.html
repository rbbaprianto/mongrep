<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRM Labs MongoDB Management Dashboard v2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --dark-color: #343a40;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .navbar {
            background: var(--primary-gradient);
            box-shadow: 0 4px 6px rgba(0,0,0,.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,.1);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,.15);
        }
        
        .stats-card {
            background: var(--primary-gradient);
            color: white;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            pointer-events: none;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .status-primary { background-color: var(--success-color); }
        .status-secondary { background-color: var(--info-color); }
        .status-analytics { background-color: var(--warning-color); }
        .status-offline { background-color: var(--danger-color); animation: none; }
        
        .log-container {
            background: #1e1e1e;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #333;
        }
        
        .terminal-container {
            background: #000;
            border-radius: 10px;
            padding: 0;
            height: 400px;
            overflow: hidden;
            border: 2px solid #333;
        }
        
        .query-editor {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 14px;
        }
        
        .btn-custom {
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,.2);
        }
        
        .node-card {
            border-left: 5px solid;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .node-card:hover {
            transform: translateX(5px);
        }
        
        .node-card.primary { border-left-color: var(--success-color); }
        .node-card.secondary { border-left-color: var(--info-color); }
        .node-card.analytics { border-left-color: var(--warning-color); }
        
        .nav-pills .nav-link {
            border-radius: 25px;
            margin-right: 10px;
            transition: all 0.3s ease;
        }
        
        .nav-pills .nav-link.active {
            background: var(--primary-gradient);
            transform: translateY(-2px);
        }
        
        .progress {
            height: 25px;
            border-radius: 15px;
            background: rgba(0,0,0,.1);
        }
        
        .progress-bar {
            border-radius: 15px;
            background: var(--primary-gradient);
            transition: width 0.5s ease;
        }
        
        .installation-log {
            max-height: 300px;
            overflow-y: auto;
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.error { color: #ff6b6b; }
        .log-entry.warning { color: #ffd93d; }
        .log-entry.info { color: #6bcf7f; }
        
        .modal-lg {
            max-width: 90%;
        }
        
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        
        .alert {
            border-radius: 15px;
            border: none;
        }
        
        .badge {
            border-radius: 10px;
            padding: 5px 10px;
        }
        
        .system-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,.1);
        }
        
        .installation-wizard {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .feature-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .feature-card:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-5px);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h4 id="loadingText">Initializing Dashboard...</h4>
            <p id="loadingSubtext">Please wait while we set up your environment.</p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-database me-2"></i>
                HRM Labs MongoDB Dashboard v2.0
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <span class="status-indicator" id="connectionStatus"></span>
                    <span id="connectionText">Connecting...</span>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="showHealthCheck()">
                    <i class="fas fa-heartbeat me-1"></i>
                    Health Check
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Installation Wizard -->
        <div class="installation-wizard" id="installationWizard" style="display: none;">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2><i class="fas fa-rocket me-2"></i>MongoDB Cluster Installation</h2>
                    <p class="mb-3">Complete automation for MongoDB replication cluster setup with monitoring dashboard.</p>
                    <div class="feature-grid">
                        <div class="feature-card">
                            <i class="fas fa-server fa-2x mb-2"></i>
                            <h6>Auto Installation</h6>
                            <small>MongoDB on all nodes</small>
                        </div>
                        <div class="feature-card">
                            <i class="fas fa-copy fa-2x mb-2"></i>
                            <h6>Replication Setup</h6>
                            <small>3-node cluster config</small>
                        </div>
                        <div class="feature-card">
                            <i class="fas fa-database fa-2x mb-2"></i>
                            <h6>Test Data</h6>
                            <small>HR sample data</small>
                        </div>
                        <div class="feature-card">
                            <i class="fas fa-chart-line fa-2x mb-2"></i>
                            <h6>Live Monitoring</h6>
                            <small>Real-time dashboard</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <button class="btn btn-light btn-lg btn-custom" id="startInstallationBtn" onclick="startInstallation()">
                        <i class="fas fa-play me-2"></i>
                        Start Installation
                    </button>
                    <div class="mt-3">
                        <small>This will take approximately 5-10 minutes</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Installation Progress -->
        <div class="card mb-4" id="installationProgress" style="display: none;">
            <div class="card-header">
                <h5><i class="fas fa-cogs me-2"></i>Installation Progress</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span id="currentStep">Preparing...</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="installation-log" id="installationLog">
                            <div class="log-entry info">Installation will begin shortly...</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-3" role="status" id="installationSpinner">
                                <span class="visually-hidden">Installing...</span>
                            </div>
                            <h6 id="installationPhase">Initializing</h6>
                            <button class="btn btn-outline-danger btn-sm" onclick="cancelInstallation()" id="cancelBtn">
                                <i class="fas fa-stop me-1"></i>Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Cards -->
        <div class="row mb-4" id="statusCards">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="fas fa-server fa-3x mb-3"></i>
                        <h5>Replica Set</h5>
                        <h3 id="replica-status">Checking...</h3>
                        <small id="replica-info">Initializing...</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-3x mb-3"></i>
                        <h5>Total Employees</h5>
                        <h3 id="total-employees">-</h3>
                        <small>HR Records</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="fas fa-building fa-3x mb-3"></i>
                        <h5>Companies</h5>
                        <h3 id="total-companies">-</h3>
                        <small>Active Organizations</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <h5>Connections</h5>
                        <h3 id="active-connections">-</h3>
                        <small>Live Sessions</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="row">
            <div class="col-md-9">
                <!-- Enhanced Tabs -->
                <ul class="nav nav-pills mb-3" id="dashboard-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="replication-tab" data-bs-toggle="pill" data-bs-target="#replication" type="button">
                            <i class="fas fa-copy me-1"></i> Replication Status
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="logs-tab" data-bs-toggle="pill" data-bs-target="#logs" type="button">
                            <i class="fas fa-file-alt me-1"></i> Live Logs
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="query-tab" data-bs-toggle="pill" data-bs-target="#query" type="button">
                            <i class="fas fa-terminal me-1"></i> Query Console
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ssh-tab" data-bs-toggle="pill" data-bs-target="#ssh" type="button">
                            <i class="fas fa-server me-1"></i> SSH Terminal
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="data-tab" data-bs-toggle="pill" data-bs-target="#data" type="button">
                            <i class="fas fa-database me-1"></i> Test Data
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="dashboard-content">
                    <!-- Replication Status -->
                    <div class="tab-pane fade show active" id="replication" role="tabpanel">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-copy me-2"></i>MongoDB Replica Set Status</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="refreshReplicationStatus()">
                                    <i class="fas fa-sync-alt me-1"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <canvas id="replicationChart" width="400" height="200"></canvas>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="replica-members">
                                            <div class="text-center text-muted">
                                                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                                <p>Loading replica set information...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <h6>System Statistics</h6>
                                    <div class="system-stats" id="systemStats">
                                        <!-- Dynamic stats will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Live Logs -->
                    <div class="tab-pane fade" id="logs" role="tabpanel">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-file-alt me-2"></i>Live MongoDB Logs</h5>
                                <div class="d-flex gap-2">
                                    <select class="form-select form-select-sm" id="log-node-select" style="width: auto;">
                                        <option value="hrmlabs-mongo-primary">Primary Node</option>
                                        <option value="hrmlabs-mongo-secondary">Secondary Node</option>
                                        <option value="hrmlabs-mongo-analytics">Analytics Node</option>
                                    </select>
                                    <button class="btn btn-outline-success btn-sm" onclick="toggleLogStreaming()" id="logStreamBtn">
                                        <i class="fas fa-play me-1"></i> Start Stream
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="log-container" id="log-output">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-file-alt fa-2x mb-2"></i>
                                        <p>Select a node and start streaming to view logs...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Query Console -->
                    <div class="tab-pane fade" id="query" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-terminal me-2"></i>MongoDB Query Console</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Target Node</label>
                                        <select class="form-select" id="query-node-select">
                                            <option value="hrmlabs-mongo-primary">Primary Node</option>
                                            <option value="hrmlabs-mongo-secondary">Secondary Node</option>
                                            <option value="hrmlabs-mongo-analytics">Analytics Node</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Database</label>
                                        <input type="text" class="form-control" id="query-database" placeholder="Database name" value="hrmlabs">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Quick Examples</label>
                                        <select class="form-select" id="query-examples" onchange="loadQueryExample()">
                                            <option value="">Select example...</option>
                                            <option value="db.employees.find().limit(5)">List Employees</option>
                                            <option value="db.companies.countDocuments()">Count Companies</option>
                                            <option value="db.employees.aggregate([{$group: {_id: '$department_id', count: {$sum: 1}}}])">Employee by Department</option>
                                            <option value="db.attendance.find({status: 'present'}).limit(10)">Attendance Records</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">MongoDB Query (Ctrl+Enter to execute)</label>
                                    <textarea class="form-control query-editor" id="query-input" rows="8" placeholder="Enter MongoDB query here...

Examples:
- db.employees.find().limit(5)
- db.companies.countDocuments()
- db.employees.aggregate([{$group: {_id: '$status', count: {$sum: 1}}}])"></textarea>
                                </div>
                                <div class="d-flex gap-2 mb-3">
                                    <button class="btn btn-primary btn-custom" onclick="executeQuery()">
                                        <i class="fas fa-play me-1"></i> Execute Query
                                    </button>
                                    <button class="btn btn-outline-secondary btn-custom" onclick="clearQuery()">
                                        <i class="fas fa-eraser me-1"></i> Clear
                                    </button>
                                    <button class="btn btn-outline-info btn-custom" onclick="formatQuery()">
                                        <i class="fas fa-code me-1"></i> Format
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <h6>Query Result</h6>
                                    <pre id="query-result" class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">Ready to execute queries...</pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SSH Terminal -->
                    <div class="tab-pane fade" id="ssh" role="tabpanel">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-server me-2"></i>SSH Terminal</h5>
                                <div class="d-flex gap-2">
                                    <select class="form-select form-select-sm" id="ssh-node-select" style="width: auto;">
                                        <option value="primary">Primary Node</option>
                                        <option value="secondary">Secondary Node</option>
                                        <option value="analytics">Analytics Node</option>
                                    </select>
                                    <button class="btn btn-outline-success btn-sm" onclick="createNewTerminal()" id="newTerminalBtn">
                                        <i class="fas fa-plus me-1"></i> New Terminal
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="terminal-container" id="terminal-container">
                                    <div class="d-flex justify-content-center align-items-center h-100 text-muted">
                                        <div class="text-center">
                                            <i class="fas fa-terminal fa-3x mb-3"></i>
                                            <p>Click "New Terminal" to start an SSH session</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Data Generator -->
                    <div class="tab-pane fade" id="data" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-database me-2"></i>Test Data Generator</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Generate Sample HR Data</h6>
                                        <p class="text-muted">Create realistic test data for your MongoDB cluster including employees, companies, departments, and more.</p>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Number of Employees</label>
                                            <input type="number" class="form-control" id="employee-count" value="100" min="10" max="1000">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="include-files" checked>
                                                <label class="form-check-label" for="include-files">
                                                    Include document files (photos, contracts)
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="clear-existing" checked>
                                                <label class="form-check-label" for="clear-existing">
                                                    Clear existing data before generation
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <button class="btn btn-success btn-custom" onclick="generateTestData()" id="generateDataBtn">
                                            <i class="fas fa-magic me-2"></i>
                                            Generate Test Data
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Data Overview</h6>
                                        <div class="row">
                                            <div class="col-6 mb-3">
                                                <div class="stat-item">
                                                    <i class="fas fa-building text-primary fa-2x mb-2"></i>
                                                    <h4 id="data-companies">5</h4>
                                                    <small>Companies</small>
                                                </div>
                                            </div>
                                            <div class="col-6 mb-3">
                                                <div class="stat-item">
                                                    <i class="fas fa-users text-success fa-2x mb-2"></i>
                                                    <h4 id="data-employees">100</h4>
                                                    <small>Employees</small>
                                                </div>
                                            </div>
                                            <div class="col-6 mb-3">
                                                <div class="stat-item">
                                                    <i class="fas fa-calendar text-warning fa-2x mb-2"></i>
                                                    <h4 id="data-attendance">1500+</h4>
                                                    <small>Attendance</small>
                                                </div>
                                            </div>
                                            <div class="col-6 mb-3">
                                                <div class="stat-item">
                                                    <i class="fas fa-file text-info fa-2x mb-2"></i>
                                                    <h4 id="data-documents">40+</h4>
                                                    <small>Documents</small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>Note:</strong> Test data includes realistic HR information with proper relationships between entities.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Sidebar -->
            <div class="col-md-3">
                <!-- Node Status -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-server me-2"></i>Cluster Nodes</h5>
                    </div>
                    <div class="card-body" id="node-status">
                        <div class="text-center text-muted">
                            <div class="spinner-border spinner-border-sm mb-2"></div>
                            <p>Loading node status...</p>
                        </div>
                    </div>
                </div>

                <!-- System Actions -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-cog me-2"></i>System Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-custom" onclick="refreshAll()">
                                <i class="fas fa-sync-alt me-1"></i> Refresh All
                            </button>
                            <button class="btn btn-outline-success btn-custom" onclick="exportConfiguration()">
                                <i class="fas fa-download me-1"></i> Export Config
                            </button>
                            <button class="btn btn-outline-info btn-custom" onclick="backupDatabase()">
                                <i class="fas fa-shield-alt me-1"></i> Backup DB
                            </button>
                            <button class="btn btn-outline-warning btn-custom" onclick="restartServices()">
                                <i class="fas fa-redo me-1"></i> Restart Services
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar me-2"></i>Quick Stats</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Uptime</span>
                                <span id="system-uptime">-</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Data Size</span>
                                <span id="data-size">-</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Collections</span>
                                <span id="collection-count">-</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Indexes</span>
                                <span id="index-count">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Health Check Modal -->
    <div class="modal fade" id="healthModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-heartbeat me-2"></i>System Health Check
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="healthCheckContent">
                        <div class="text-center">
                            <div class="spinner-border mb-3"></div>
                            <p>Running health check...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let socket;
        let replicationChart;
        let logStreamInterval;
        let currentTerminal;
        let terminalSocket;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            showLoadingOverlay('Initializing Dashboard...', 'Connecting to server...');
            initializeSocketConnection();
            initializeChart();
            checkInstallationStatus();
            
            // Auto-refresh intervals
            setInterval(loadNodeStatus, 30000);
            setInterval(loadStats, 60000);
            
            setTimeout(hideLoadingOverlay, 2000);
        });
        
        // Socket.IO connection
        function initializeSocketConnection() {
            socket = io();
            
            socket.on('connect', function() {
                updateConnectionStatus(true);
                console.log('Connected to dashboard');
            });
            
            socket.on('disconnect', function() {
                updateConnectionStatus(false);
                console.log('Disconnected from dashboard');
            });
            
            socket.on('installation-status', function(status) {
                updateInstallationProgress(status);
            });
            
            socket.on('installation-log', function(logEntry) {
                appendInstallationLog(logEntry);
            });
            
            socket.on('replication-status', function(status) {
                updateReplicationStatus(status);
            });
            
            socket.on('node-stats', function(stats) {
                updateNodeStats(stats);
            });
            
            socket.on('live-logs', function(data) {
                updateLiveLogs(data);
            });
            
            socket.on('test-data-generated', function(result) {
                handleTestDataResult(result);
            });
        }
        
        function updateConnectionStatus(connected) {
            const statusIndicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            
            if (connected) {
                statusIndicator.className = 'status-indicator status-primary';
                statusText.textContent = 'Connected';
            } else {
                statusIndicator.className = 'status-indicator status-offline';
                statusText.textContent = 'Disconnected';
            }
        }
        
        // Loading overlay functions
        function showLoadingOverlay(title, subtitle) {
            document.getElementById('loadingText').textContent = title;
            document.getElementById('loadingSubtext').textContent = subtitle;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        // Installation functions
        async function checkInstallationStatus() {
            try {
                const response = await fetch('/api/installation-status');
                const result = await response.json();
                
                if (result.success) {
                    const status = result.data;
                    if (status.phase === 'idle' && status.progress === 0) {
                        showInstallationWizard();
                    } else if (status.phase === 'completed') {
                        showMainDashboard();
                        loadInitialData();
                    } else {
                        showInstallationProgress();
                        updateInstallationProgress(status);
                    }
                }
            } catch (error) {
                console.error('Error checking installation status:', error);
                showMainDashboard();
            }
        }
        
        function showInstallationWizard() {
            document.getElementById('installationWizard').style.display = 'block';
            document.getElementById('statusCards').style.display = 'none';
        }
        
        function showInstallationProgress() {
            document.getElementById('installationWizard').style.display = 'none';
            document.getElementById('installationProgress').style.display = 'block';
            document.getElementById('statusCards').style.display = 'none';
        }
        
        function showMainDashboard() {
            document.getElementById('installationWizard').style.display = 'none';
            document.getElementById('installationProgress').style.display = 'none';
            document.getElementById('statusCards').style.display = 'flex';
        }
        
        async function startInstallation() {
            try {
                const btn = document.getElementById('startInstallationBtn');
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting...';
                btn.disabled = true;
                
                const response = await fetch('/api/install', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showInstallationProgress();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                alert('Failed to start installation: ' + error.message);
                const btn = document.getElementById('startInstallationBtn');
                btn.innerHTML = '<i class="fas fa-play me-2"></i>Start Installation';
                btn.disabled = false;
            }
        }
        
        function updateInstallationProgress(status) {
            document.getElementById('currentStep').textContent = status.currentStep;
            document.getElementById('progressPercent').textContent = status.progress + '%';
            document.getElementById('progressBar').style.width = status.progress + '%';
            document.getElementById('installationPhase').textContent = status.phase.charAt(0).toUpperCase() + status.phase.slice(1);
            
            if (status.phase === 'completed') {
                document.getElementById('installationSpinner').style.display = 'none';
                document.getElementById('cancelBtn').style.display = 'none';
                setTimeout(() => {
                    showMainDashboard();
                    loadInitialData();
                }, 2000);
            } else if (status.phase === 'error') {
                document.getElementById('installationSpinner').innerHTML = '<i class="fas fa-exclamation-triangle text-danger fa-2x"></i>';
                document.getElementById('cancelBtn').innerHTML = '<i class="fas fa-redo me-1"></i>Retry';
                document.getElementById('cancelBtn').onclick = () => location.reload();
            }
        }
        
        function appendInstallationLog(logEntry) {
            const logContainer = document.getElementById('installationLog');
            const logElement = document.createElement('div');
            logElement.className = `log-entry ${logEntry.type}`;
            logElement.innerHTML = `[${new Date(logEntry.timestamp).toLocaleTimeString()}] ${logEntry.message}`;
            
            logContainer.appendChild(logElement);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // Chart initialization
        function initializeChart() {
            const ctx = document.getElementById('replicationChart').getContext('2d');
            replicationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Primary', 'Secondary', 'Analytics'],
                    datasets: [{
                        data: [1, 1, 1],
                        backgroundColor: ['#28a745', '#17a2b8', '#ffc107'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Data loading functions
        async function loadInitialData() {
            await Promise.all([
                loadNodeStatus(),
                loadStats(),
                loadReplicationStatus()
            ]);
        }
        
        async function loadNodeStatus() {
            try {
                const response = await fetch('/api/nodes');
                const result = await response.json();
                
                if (result.success) {
                    updateNodeStatusDisplay(result.data);
                }
            } catch (error) {
                console.error('Error loading node status:', error);
            }
        }
        
        function updateNodeStatusDisplay(nodes) {
            const container = document.getElementById('node-status');
            let html = '';
            
            nodes.forEach((node, index) => {
                const nodeType = index === 0 ? 'primary' : index === 1 ? 'secondary' : 'analytics';
                const statusColor = node.mongoConnected ? 'success' : 'danger';
                const sshColor = node.sshConnected ? 'success' : 'danger';
                
                html += `
                    <div class="node-card ${nodeType} card p-3 mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>${node.name}</strong>
                            <div>
                                <span class="badge bg-${statusColor} me-1">
                                    <i class="fas fa-database"></i>
                                </span>
                                <span class="badge bg-${sshColor}">
                                    <i class="fas fa-terminal"></i>
                                </span>
                            </div>
                        </div>
                        ${node.stats && !node.stats.error ? `
                            <small class="text-muted">
                                CPU: ${node.stats.cpu}% | 
                                RAM: ${node.stats.memory}% | 
                                Disk: ${node.stats.disk}
                            </small>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function loadStats() {
            try {
                // Load employee count
                const employeeResponse = await fetch('/api/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        node: 'hrmlabs-mongo-primary',
                        database: 'hrmlabs',
                        query: 'db.employees.countDocuments()'
                    })
                });
                
                const employeeResult = await employeeResponse.json();
                if (employeeResult.success && employeeResult.data.retval !== undefined) {
                    document.getElementById('total-employees').textContent = employeeResult.data.retval;
                }
                
                // Load company count
                const companyResponse = await fetch('/api/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        node: 'hrmlabs-mongo-primary',
                        database: 'hrmlabs',
                        query: 'db.companies.countDocuments()'
                    })
                });
                
                const companyResult = await companyResponse.json();
                if (companyResult.success && companyResult.data.retval !== undefined) {
                    document.getElementById('total-companies').textContent = companyResult.data.retval;
                }
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        async function loadReplicationStatus() {
            try {
                const response = await fetch('/api/status');
                const result = await response.json();
                
                if (result.success && result.data) {
                    updateReplicationStatus(result.data);
                }
            } catch (error) {
                console.error('Error loading replication status:', error);
            }
        }
        
        function updateReplicationStatus(status) {
            if (status && status.members) {
                document.getElementById('replica-status').textContent = 'Healthy';
                document.getElementById('replica-info').textContent = `${status.members.length} members`;
                
                let membersHtml = '';
                status.members.forEach(member => {
                    const stateText = member.stateStr || 'Unknown';
                    const healthClass = member.health === 1 ? 'success' : 'danger';
                    
                    membersHtml += `
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                            <div>
                                <strong>${member.name}</strong>
                                <br><small class="text-muted">${member._id === 0 ? 'Primary' : member._id === 1 ? 'Secondary' : 'Analytics'}</small>
                            </div>
                            <span class="badge bg-${healthClass}">${stateText}</span>
                        </div>
                    `;
                });
                
                document.getElementById('replica-members').innerHTML = membersHtml;
                
                // Update system stats if available
                if (status.serverStatus) {
                    updateSystemStats(status.serverStatus, status.dbStats);
                }
            } else {
                document.getElementById('replica-status').textContent = 'Error';
                document.getElementById('replica-info').textContent = 'Check connection';
            }
        }
        
        function updateSystemStats(serverStatus, dbStats) {
            const statsContainer = document.getElementById('systemStats');
            
            const stats = [
                { label: 'Uptime', value: Math.floor(serverStatus.uptime / 3600) + 'h', icon: 'clock' },
                { label: 'Connections', value: serverStatus.connections?.current || 0, icon: 'plug' },
                { label: 'Operations/sec', value: Math.floor((serverStatus.opcounters?.query || 0) / serverStatus.uptime), icon: 'tachometer-alt' },
                { label: 'Data Size', value: formatBytes(dbStats?.dataSize || 0), icon: 'hdd' }
            ];
            
            statsContainer.innerHTML = stats.map(stat => `
                <div class="stat-item">
                    <i class="fas fa-${stat.icon} text-primary fa-2x mb-2"></i>
                    <h5>${stat.value}</h5>
                    <small>${stat.label}</small>
                </div>
            `).join('');
            
            // Update sidebar stats
            document.getElementById('system-uptime').textContent = Math.floor(serverStatus.uptime / 3600) + ' hours';
            document.getElementById('data-size').textContent = formatBytes(dbStats?.dataSize || 0);
            document.getElementById('collection-count').textContent = dbStats?.collections || 0;
            document.getElementById('index-count').textContent = dbStats?.indexes || 0;
        }
        
        // Query functions
        function loadQueryExample() {
            const select = document.getElementById('query-examples');
            const input = document.getElementById('query-input');
            if (select.value) {
                input.value = select.value;
                select.value = '';
            }
        }
        
        async function executeQuery() {
            const node = document.getElementById('query-node-select').value;
            const database = document.getElementById('query-database').value || 'hrmlabs';
            const query = document.getElementById('query-input').value;
            
            if (!query.trim()) {
                alert('Please enter a query');
                return;
            }
            
            const resultContainer = document.getElementById('query-result');
            resultContainer.textContent = 'Executing query...';
            
            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ node, database, query })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultContainer.textContent = JSON.stringify(result.data, null, 2);
                } else {
                    resultContainer.textContent = 'Error: ' + (result.error || 'Unknown error');
                }
            } catch (error) {
                resultContainer.textContent = 'Network error: ' + error.message;
            }
        }
        
        function clearQuery() {
            document.getElementById('query-input').value = '';
            document.getElementById('query-result').textContent = 'Ready to execute queries...';
        }
        
        function formatQuery() {
            const input = document.getElementById('query-input');
            try {
                // Basic formatting for MongoDB queries
                let formatted = input.value
                    .replace(/\{/g, '{\n  ')
                    .replace(/\}/g, '\n}')
                    .replace(/,/g, ',\n  ');
                input.value = formatted;
            } catch (error) {
                console.log('Could not format query');
            }
        }
        
        // Terminal functions
        async function createNewTerminal() {
            const nodeId = document.getElementById('ssh-node-select').value;
            const btn = document.getElementById('newTerminalBtn');
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Connecting...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/terminal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nodeId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    initializeTerminal(result.data.terminalId);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                alert('Failed to create terminal: ' + error.message);
            } finally {
                btn.innerHTML = '<i class="fas fa-plus me-1"></i> New Terminal';
                btn.disabled = false;
            }
        }
        
        function initializeTerminal(terminalId) {
            const container = document.getElementById('terminal-container');
            container.innerHTML = '';
            
            // Initialize xterm.js
            currentTerminal = new Terminal({
                theme: {
                    background: '#000000',
                    foreground: '#ffffff',
                    cursor: '#ffffff'
                },
                fontSize: 14,
                rows: 24,
                cols: 80
            });
            
            const fitAddon = new FitAddon.FitAddon();
            currentTerminal.loadAddon(fitAddon);
            currentTerminal.loadAddon(new WebLinksAddon.WebLinksAddon());
            
            currentTerminal.open(container);
            fitAddon.fit();
            
            // Connect WebSocket
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            terminalSocket = new WebSocket(`${protocol}//${window.location.host}/terminal?terminalId=${terminalId}`);
            
            terminalSocket.onmessage = (event) => {
                currentTerminal.write(event.data);
            };
            
            currentTerminal.onData((data) => {
                if (terminalSocket.readyState === WebSocket.OPEN) {
                    terminalSocket.send(data);
                }
            });
            
            // Handle resize
            window.addEventListener('resize', () => {
                fitAddon.fit();
            });
        }
        
        // Log streaming functions
        function toggleLogStreaming() {
            const btn = document.getElementById('logStreamBtn');
            
            if (logStreamInterval) {
                clearInterval(logStreamInterval);
                logStreamInterval = null;
                btn.innerHTML = '<i class="fas fa-play me-1"></i> Start Stream';
                btn.className = 'btn btn-outline-success btn-sm';
            } else {
                startLogStreaming();
                btn.innerHTML = '<i class="fas fa-stop me-1"></i> Stop Stream';
                btn.className = 'btn btn-outline-danger btn-sm';
            }
        }
        
        function startLogStreaming() {
            loadLogs(); // Load initial logs
            logStreamInterval = setInterval(loadLogs, 5000); // Update every 5 seconds
        }
        
        async function loadLogs() {
            const selectedNode = document.getElementById('log-node-select').value;
            try {
                const response = await fetch(`/api/logs/${selectedNode}?lines=50`);
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('log-output').textContent = result.data.logs;
                    
                    // Auto-scroll to bottom
                    const logContainer = document.getElementById('log-output');
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }
        
        function updateLiveLogs(data) {
            document.getElementById('log-output').textContent = data.logs;
            const logContainer = document.getElementById('log-output');
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // Test data functions
        async function generateTestData() {
            const btn = document.getElementById('generateDataBtn');
            const employeeCount = document.getElementById('employee-count').value;
            const includeFiles = document.getElementById('include-files').checked;
            const clearExisting = document.getElementById('clear-existing').checked;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/generate-test-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        recordCount: parseInt(employeeCount),
                        includeFiles,
                        clearExisting
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Test data generation started!', 'info');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showNotification('Failed to generate test data: ' + error.message, 'error');
            } finally {
                btn.innerHTML = '<i class="fas fa-magic me-2"></i>Generate Test Data';
                btn.disabled = false;
            }
        }
        
        function handleTestDataResult(result) {
            if (result.success) {
                showNotification('Test data generated successfully!', 'success');
                loadStats(); // Refresh stats
            } else {
                showNotification('Test data generation failed: ' + result.error, 'error');
            }
        }
        
        // Utility functions
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
        
        // Action functions
        function refreshAll() {
            showLoadingOverlay('Refreshing...', 'Loading latest data...');
            loadInitialData().then(() => {
                hideLoadingOverlay();
                showNotification('Dashboard refreshed successfully!', 'success');
            });
        }
        
        async function refreshReplicationStatus() {
            await loadReplicationStatus();
            showNotification('Replication status refreshed!', 'info');
        }
        
        async function showHealthCheck() {
            const modal = new bootstrap.Modal(document.getElementById('healthModal'));
            modal.show();
            
            try {
                const response = await fetch('/health');
                const result = await response.json();
                
                document.getElementById('healthCheckContent').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Server Status</h6>
                            <p class="text-success"><i class="fas fa-check-circle me-2"></i>${result.status}</p>
                            
                            <h6>Version</h6>
                            <p>${result.version}</p>
                            
                            <h6>Uptime</h6>
                            <p>${Math.floor(result.uptime / 3600)} hours</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Last Updated</h6>
                            <p>${new Date(result.timestamp).toLocaleString()}</p>
                            
                            <h6>Memory Usage</h6>
                            <p>${Math.round(process.memoryUsage?.() / 1024 / 1024) || 'N/A'} MB</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('healthCheckContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Health check failed: ${error.message}
                    </div>
                `;
            }
        }
        
        function exportConfiguration() {
            showNotification('Configuration export feature will be implemented', 'info');
        }
        
        function backupDatabase() {
            showNotification('Database backup feature will be implemented', 'info');
        }
        
        function restartServices() {
            if (confirm('Are you sure you want to restart all services? This may cause temporary downtime.')) {
                showNotification('Service restart feature will be implemented', 'info');
            }
        }
        
        // Event listeners
        document.getElementById('log-node-select').addEventListener('change', () => {
            if (logStreamInterval) {
                loadLogs();
            }
        });
        
        document.getElementById('query-input').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                executeQuery();
            }
        });
        
        // Subscribe to live logs
        socket?.on('connect', () => {
            socket.emit('subscribe-logs', { node: 'hrmlabs-mongo-primary' });
        });
    </script>
</body>
</html>